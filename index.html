<!DOCTYPE html>
<html lang="en">
<head>
    <title>HexGen</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="./mats/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="./scripts/js/add_audio.js"></script>
    <script src="./scripts/js/js_utils.js"></script>
    <script src="./scripts/js/data_read_write.js"></script>
    <script src="./scripts/js/init_hex.js"></script>
    <script src="./scripts/js/ripple.js"></script>
    <script src="./scripts/js/render_hex.js"></script>
    <script src="./scripts/js/add_lava.js"></script>
    <script src="./scripts/js/create_clouds.js"></script>
    <script src="./scripts/js/sel_terrain.js"></script>
    <script src="./scripts/js/assign_strongholds.js"></script>
    <script src="./scripts/js/make_hex_map.js"></script>
    <script src="./scripts/js/make_hex_flower.js"></script>
    <script src="./scripts/js/make_hex_flower_draggable.js"></script>
    <script src="./scripts/js/get_terr_for_hex_flower.js"></script>
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/hexagon_styles.css" />
</head>
<body style = 'height: 97vh;'>
  <div id = 'page_content' class = 'container'>
    <div id = 'sidebar' class = 'sidebar center-text'>
          <h1 class="over-background endor">HexGen</h3>
          <h3 class = 'over-background endor'>Project Name:</h5>
          <!--<div id = 'switch_zoom' class = 'dnd-button' style = 'position: absolute; top: 50px; left: 50px;'>Switch Zoom</div>-->
            <input type="text" style = 'width:80%;height:25px;opacity:0.8;border-radius:3px;margin-top: -2rem;'></input>
            <div class = 'row' style = 'width: 100%;'>
              <div id = 'save_proj' class = 'dnd-button navbar-button' style = 'position:relative; width: 75%; left: 0%; margin-right: 5px !important;'>Save</div>
              <div id = 'load_proj' class = 'dnd-button navbar-button' style = 'position:relative; width: 75%; left: 0%; margin-left: 5px !important;'>Load</div>  
            </div>
              <div class = 'over-background' style="text-align:center;padding-left:5%;padding-right:5%;">
              <h4 style="display: inline;font-family:endor;">Horizontal<br></h4>
              <div class = 'row'>
                <p>24</p>
                <!--<input id = 'number_hex_h' type="range" id="slider1" min="3" max="65" value="35" step="1">-->
                <!--<span id="slider-value1">35</span>-->
                <input id = 'number_hex_h' type="range" min="24" max="65" value="24" step="1">
                <p>65</p>
              </div>
          </div>
            <div class = 'over-background' style="text-align:center;padding-left:5%;padding-right:5%;">
              <h4 style="display: inline;font-family:endor;">Vertical<br></h4>
              <div class = 'row'>
                <p>15</p>
                <!--<input id = 'number_hex_v' type="range" id="slider2" min="3" max="45" value="25" step="1">-->
                <!--<span id="slider-value2">25</span>-->
                <input id = 'number_hex_v' type="range" min="15" max="45" value="15" step="1">
                <p>45</p>
            </div>
        </div>
          <div id = 'make_hex' class = 'dnd-button'>Create Hex Map</div>
          <div id = 'randomize_terrain' class = 'dnd-button'>Roll up Terrain</div>
          <div id = 'apply_waterways' class = 'dnd-button'>Add Rivers & Paths</div>
          <div id = 'apply_features' class = 'dnd-button'>Generate Features</div>
          <div class = 'over-background' style="text-align:center">
            <div class = 'row'>
              <img id = 'skip_last_audio' src = 'mats/left-arrow.svg' class = 'music-button arrows'></img>
              <img id = 'start_music' src = 'mats/icons8-harp-64.png' class = 'music-button' style = 'width:35px;'></img>
              <img id = 'skip_next_audio' src = 'mats/left-arrow.svg' class = 'music-button arrows' style = 'transform: rotate(180deg);'></img>
            </div>
          </div>
    </div>
    <div id = 'main' class = 'main'>
      <div id = 'hex_gen_page' class = "hex-gen-page">
      <div id= "lava-gradient-box" class = 'lava-background'>
        <!--<div id = 'lava_goop' class = 'lava-goop'>-->
        <!--<div id = 'lava_veins' class = 'lava-veins'></div>
        </div>-->
      </div>
      <div id = 'hex_layer' class = 'hex-layer'></div>
      <div id = 'hex_flower_container' class = 'hex-flower-container'></div> 
      <div id = 'waterways' class = 'waterways'></div>
      <div id = 'zoom_layer' class = 'zoomlayer'></div>
      </div>
      <input type="file" id="fileInput" style="display: none;">
      </div>
    </div>
  </div>
  <audio id = 'bg_music_1' src = "https://fi.zophar.net/soundfiles/nintendo-snes-spc/chrono-trigger/102%20Chrono%20Trigger%20%28Looped%29.mp3?raw=true"></audio>
  <audio id = 'bg_music_2' src = "https://vgmsite.com/soundtracks/warcraft-2-tides-of-darkness-cda/ljjizkibrg/02%20-%20Human%20Battle%2001.mp3?raw=true""></audio>
  <audio id = 'bg_music_3' src = "https://fi.zophar.net/soundfiles/nintendo-snes-spc/chrono-trigger/109%20Wind%20Scene.mp3?raw=true"></audio>
  <audio id = 'bg_music_4' src = "https://vgmsite.com/soundtracks/warcraft-2-tides-of-darkness-cda/llhafojenj/11%20-%20Orc%20Battle%2001.mp3"></audio>
  <audio id = 'bg_music_5' src = "https://fi.zophar.net/soundfiles/nintendo-snes-spc/chrono-trigger/119%20Frog%27s%20Theme.mp3?raw=true"></audio>
  <audio id = 'tile-click-noise' src = './mats/notification-sound-7062.mp3', type="audio/mp3"></audio>
  <script>

    document.getElementById('page_content').style.height = window.innerHeight*0.97 + 'px';

    add_audio();
    enable_downloads('save_proj');
    
    function read_saved_data(data) {
    make_hex_map_from_loaded_data(data);
    }
    enable_data_reads('load_proj',read_saved_data);

    let numRows = 0; 
    let numCols = 0; 
    let container_height = document.getElementById('hex_gen_page').offsetHeight;
    let container_width = document.getElementById('hex_gen_page').offsetWidth;
    hexagon_map_container = document.getElementById('hex_gen_page');

    const make_hex_button = document.getElementById('make_hex');
    
    make_hex_button.addEventListener('click', function() {

      numRows = number_hex_v.value;
      numCols = number_hex_h.value;
      container_height = document.getElementById('hex_gen_page').offsetHeight;
      container_width = document.getElementById('hex_gen_page').offsetWidth;

      make_hex_map(numRows, numCols, container_height, container_width, 
      make_clouds = true);
    });
      
    const random_terrain_button = document.getElementById('randomize_terrain');
    
    random_terrain_button.addEventListener('click', function() {

      numRows = number_hex_v.value;
      numCols = number_hex_h.value;
      container_height = document.getElementById('hex_gen_page').offsetHeight;
      container_width = document.getElementById('hex_gen_page').offsetWidth;

    //select_terrain_type();
    select_terrain_type(
      terrain_types = ['wooded', 'desert', 'mountain', 'swamp', 'open'],
      // ideal/finished proportions = [0.2976, 0.0585, 0.1837, 0.0345, 0.4257871064],
      terrain_proportions = [0.4418, 0.0685, 0.1937, 0.0345, 0.001], // we increase the earlier types because so many are overwritten                                                                          
      terrain_replace_list = [
        [],   // wooded first, replaces nothing 
        ['wooded'], // desert
        ['wooded','desert'], // mountain
        ['wooded','desert','mountain'], // 'swamp' replaces all
        ['wooded','desert','mountain', 'swamp'] // optional open iteration breaks up some of the geomorphs unpredictably 
        ],
      elevation_classes = ['elevation_3', 'elevation_4', 'elevation_6', 'elevation_1', 'elevation_2'], // elevation classes for terrain types
      elevation_replacements = [
        [], // woods
        ['elevation_3'], // desert
        ['elevation_3','elevation_4'], // mountain
        ['elevation_3','elevation_4','elevation_6'], // swamp
        ['elevation_3','elevation_4','elevation_6','elevation_1'] // optional open 

        ], 
      delay = 500 // this number is in milliseconds, and is totally optional; could be 0.
    );
  });

  const rivers_button = document.getElementById('apply_waterways');
  rivers_button.addEventListener('click', function() {
    numRows = number_hex_v.value;
    numCols = number_hex_h.value;
    container_height = document.getElementById('hex_gen_page').offsetHeight;
    container_width = document.getElementById('hex_gen_page').offsetWidth;
        
    apply_waterways(
      //on_which_terrain_types = ['wooded', 'wooded_hills', 'desert', 'mountain', 'swamp', 'open'],
      //chance_for_SH = [0.0303030303, 0.01492537313, 0, 0.06140350877, 0.02173913043, 0], 
      //chance_for_town = [0.002518891688, 0, 0, 0, 0, 0.01408450704],
      //delay = 250 // this number is in milliseconds, and is totally optional; could be 0.
    );
  });

  const features_button = document.getElementById('apply_features');
  features_button.addEventListener('click', function() {
        
    numRows = number_hex_v.value;
    numCols = number_hex_h.value;
    container_height = document.getElementById('hex_gen_page').offsetHeight;
    container_width = document.getElementById('hex_gen_page').offsetWidth;
        
    apply_strongholds(
      on_which_terrain_types = ['wooded', 'wooded_hills', 'desert', 'mountain', 'swamp', 'open'],
      chance_for_SH = [0.0303030303, 0.01492537313, 0, 0.06140350877, 0.02173913043, 0], 
      chance_for_town = [0.002518891688, 0, 0, 0, 0, 0.01408450704],
      delay = 250 // this number is in milliseconds, and is totally optional; could be 0.
    );
  });
            
    // Create hexagon flower for Arneson cells. Make it draggable by mouse.
    make_hex_flower(0.8);
    make_hex_flower_draggable();
    get_terr_for_hex_flower(hexagon_map_container);

    // Temporary section for adding hexagon selection mouse-over event.
    //document.getElementById('zoom_layer').addEventListener('mouseover', (event) => {
    //  if(event.target && event.target.tagName === "DIV" && event.parentNode.children[1].id == 'hex_layer'){
    //    event.target.parentNode.children[1].
    //  }
    //});


    // Add in hexagon hovering selection THROUGH the zoom layer...
    hovered_hexagon = null;

    document.getElementById('zoom_layer').addEventListener('mousemove', (event) => {
    // Check if the target is a "hex" div
    if (event.target && event.target.classList.contains('zoomlayer')) {

        // Get mouse position, adjusted for position inside hex_gen_page.
        mouse_x = event.clientX; //- (window.innerWidth - document.getElementById('zoom_layer').offsetWidth);
        mouse_y = event.clientY; //- (window.innerHeight - document.getElementById('zoom_layer').offsetHeight);

        // Calculate which div the mouse is hovering over.
        const hexagons = document.getElementsByClassName('hex-center');

        // Has a hexagon previously been highlighted, but now is not under the cursor?
        // If so, remove highlight from such hex.
        if(hovered_hexagon != null){
          rect = hovered_hexagon.getBoundingClientRect();

          if (mouse_x < rect.left | mouse_x > rect.right | mouse_y < rect.top | mouse_y > rect.bottom){
            hovered_hexagon.classList.remove('hovered');
            hovered_hexagon = null;
          }
        }

        for (let i = 0; i < hexagons.length; i++) {
          const div = hexagons[i];
          const rect = div.getBoundingClientRect();

          // If the mouse is over hexagon i ...
          if (mouse_x >= rect.left && mouse_x <= rect.right && mouse_y >= rect.top && mouse_y <= rect.bottom) {
            // Is this hexagon newly highlighted?
            if(hovered_hexagon != div){
              // Remove 'hovered' from previously highlighted div
              if(hovered_hexagon != null){
              hovered_hexagon.classList.remove('hovered');
              }
              hovered_hexagon = div;
              if(!div.classList.contains('hovered') && current_zoom <= 2){
                hovered_hexagon.classList.add('hovered');
              }
              break;
            }
          }
        }
    }
    });
   // Temporary section for adding scroll zoom.
   // Resume later!
    let current_zoom = 1; // Farthest out is 1, farthest in could be 10.
    let current_zoom_unbinned = 2;
    let lastKnownScrollPosition = 0;
    let min_zoom = 1;
    let max_zoom = 10;
  
    // Add mouse scroll event listener to the 'zoom_layer' div.
    document.getElementById('zoom_layer').addEventListener('wheel', (event) => {
      current_zoom_unbinned = lastKnownScrollPosition - event.deltaY * 0.01;
      lastKnownScrollPosition = current_zoom_unbinned;
      
      //mouse_x = event.clientX - (window.innerWidth - document.getElementById('zoom_layer').offsetWidth);
      //mouse_y = event.clientY - (window.innerHeight - document.getElementById('zoom_layer').offsetHeight);
      //hovered_hexagon = Array.from(document.getElementsByClassName('hovered'))[0];

      //mouse_x = hovered_hexagon.offsetLeft + (hovered_hexagon.offsetWidth/2);
      //mouse_y = hovered_hexagon.offsetTop + (hovered_hexagon.offsetHeight/2);
      console.log(`current_zoom_unbinned: ${current_zoom_unbinned}`);
      //console.log(current_zoom);

      // ZOOM OUT
      if(current_zoom_unbinned <= -1 && current_zoom > min_zoom){
        current_zoom = current_zoom - 1;
        current_zoom_unbinned = 0;
        lastKnownScrollPosition = 0;
        console.log(`current_zoom ${current_zoom}`);
        //document.getElementById('hex_gen_page').classList.toggle('zoomed');
        document.getElementById('hex_gen_page').style.transform = `scale(${current_zoom})`;
        // Adjust hexagon sizes.
        
        //Array.from(document.getElementsByClassName('hex-center')).forEach((el) => {
        //  el.style.width = current_zoom * 100 + '%';
        //  el.style.height = current_zoom * 100 + '%';
        //  el.style.top = current_zoom * parseInt(el.style.top) + 'px';
        //  el.style.left = current_zoom * parseInt(el.style.left) + 'px';
        //});

        numRows = number_hex_v.value;
        numCols = number_hex_h.value;
        //container_height = document.getElementById('hex_gen_page').offsetHeight * current_zoom;
        //container_width = document.getElementById('hex_gen_page').offsetWidth * current_zoom;
        // Adjust hexagon sizes.
        //render_hexagons(numCols, numRows, container_height, container_width, current_zoom, rerender = true);
      }
 
      // ZOOM IN
      if(current_zoom_unbinned >= 1 && current_zoom < max_zoom){
        current_zoom = current_zoom + 1;
        current_zoom_unbinned = 0;
        lastKnownScrollPosition = 0;
        console.log(`current_zoom ${current_zoom}`);
        //document.getElementById('hex_gen_page').classList.toggle('zoomed');
        document.getElementById('hex_gen_page').style.transform = `scale(${current_zoom})`;
        
 
        // Check for whoosh
        if(current_zoom == 6){
          console.log('whoosh!')
        }
 
        numRows = number_hex_v.value;
        numCols = number_hex_h.value;
        //container_height = document.getElementById('hex_gen_page').offsetHeight * current_zoom;
        //container_width = document.getElementById('hex_gen_page').offsetWidth * current_zoom;
        // Adjust hexagon sizes.
        //render_hexagons(numCols, numRows, container_height, container_width, current_zoom, rerender = true);
        //Array.from(document.getElementsByClassName('hex-center')).forEach((el) => {
        //  el.style.width = current_zoom * 100 + '%';
        //  el.style.height = current_zoom * 100 + '%';
        //  el.style.top = current_zoom * parseInt(el.style.top) + 'px';
        //  el.style.left = current_zoom * parseInt(el.style.left) + 'px';
        //});
      }

      // If current zoom unbinned is getting ridiculously negative or positive, set back to 0.
      if(current_zoom_unbinned < -2.5 | current_zoom_unbinned > 2.5){
        current_zoom_unbinned = 0;
        lastKnownScrollPosition = 0;
      }

      if(current_zoom == 1 & current_zoom_unbinned < 0) {
        current_zoom_unbinned = 0;
        lastKnownScrollPosition = 0;
      }

      event.preventDefault();
    });
  </script>
</body>
</html>
